{% extends "myapp/base.html" %}
{% block content %}
    <h1 class="text-2xl text-center font-semibold mb-4">My Tickets</h1>
    
    {% if bookings %}
        <table class="table-auto text-center">
            <thead>
                <tr>
                    <th class="px-4 py-2">Passenger info</th>
                    <th class="px-4 py-2">Passenger Age</th>
                    <th class="px-4 py-2">Edit</th>
                    <th class="px-4 py-2">Train Number</th>
                    <th class="px-4 py-2">Ticket Type</th>
                    <th class="px-4 py-2">Fare</th>
                    <th class="px-4 py-2">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                    <tr>
                        <td class="border px-4 py-2">
                            <span id="passenger_name_{{ booking.id }}">{{ booking.passenger_first_name }}</span>
                            <input type="text" id="edit_passenger_name_{{ booking.id }}" style="display: none;" value="{{ booking.passenger_first_name }}">
                        </td>
                        <td class="border px-4 py-2">
                            <span id="passenger_age_{{ booking.id }}">{{ booking.passenger_age }}</span>
                            <input type="number" min="0" max="100" id="edit_passenger_age_{{ booking.id }}" style="display: none;" value="{{ booking.passenger_age }}">
                        </td>
                        <td class="border px-4 py-2">
                            <button onclick="editPassenger({{ booking.id }})">Edit</button>
                            <button onclick="saveChanges({{ booking.id }})" style="display: none;">Save</button>
                            <button onclick="cancelChanges({{ booking.id }})" style="display: none;">Cancel</button>
                        </td>
                        <td class="border px-4 py-2">{{ booking.train_number }}</td>
                        <td class="border px-4 py-2">{{ booking.ticket_type }}</td>
                        <td class="border px-4 py-2">Rs.{{ booking.fare }}</td>
                        <td class="border px-4 py-2">
                            {% if booking.cancel_status %}
                                Rejected
                            {% else %}
                                Active
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-center">No bookings available.</p>
    {% endif %}

    <script>
        function editPassenger(bookingId) {
            document.getElementById(`passenger_name_${bookingId}`).style.display = 'none';
            document.getElementById(`edit_passenger_name_${bookingId}`).style.display = 'inline-block';

            document.getElementById(`passenger_age_${bookingId}`).style.display = 'none';
            document.getElementById(`edit_passenger_age_${bookingId}`).style.display = 'inline-block';

            document.querySelector(`button[onclick="editPassenger(${bookingId})"]`).style.display = 'none';
            document.querySelector(`button[onclick="saveChanges(${bookingId})"]`).style.display = 'inline-block';
            document.querySelector(`button[onclick="cancelChanges(${bookingId})"]`).style.display = 'inline-block';

        }

        function saveChanges(bookingId) {
            const newName = document.getElementById(`edit_passenger_name_${bookingId}`).value;
            const newAge = document.getElementById(`edit_passenger_age_${bookingId}`).value;
            const newData = { newName, newAge };
            fetch(`edit_passenger/${bookingId}/`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                },
                body: JSON.stringify(newData),
            })
            .then(response=>response.json())
            .then(data=>{
                if(data.success){
                    alert(data.message)
                    location.reload()
                }else{
                    alert('error', data.message)
                }

            })
            .catch(error=>{
                console.error(error)
            })
            document.getElementById(`passenger_name_${bookingId}`).textContent = newName;
            document.getElementById(`passenger_age_${bookingId}`).textContent = newAge;

            document.getElementById(`passenger_name_${bookingId}`).style.display = 'inline-block';
            document.getElementById(`edit_passenger_name_${bookingId}`).style.display = 'none';

            document.getElementById(`passenger_age_${bookingId}`).style.display = 'inline-block';
            document.getElementById(`edit_passenger_age_${bookingId}`).style.display = 'none';


            document.querySelector(`button[onclick="editPassenger(${bookingId})"]`).style.display = 'inline-block';
            document.querySelector(`button[onclick="saveChanges(${bookingId})"]`).style.display = 'none';
            document.querySelector(`button[onclick="cancelChanges(${bookingId})"]`).style.display = 'none';

        }
        function cancelChanges(bookingId){
            document.getElementById(`passenger_name_${bookingId}`).style.display = 'inline-block';
            document.getElementById(`edit_passenger_name_${bookingId}`).style.display = 'none';

            document.getElementById(`passenger_age_${bookingId}`).style.display = 'inline-block';
            document.getElementById(`edit_passenger_age_${bookingId}`).style.display = 'none';

            document.getElementById(`passenger_age_${bookingId}`).style.display = 'inline-blockne';
            document.getElementById(`edit_passenger_age_${bookingId}`).style.display = 'none';

            document.querySelector(`button[onclick="editPassenger(${bookingId})"]`).style.display = 'inline-block';
            document.querySelector(`button[onclick="saveChanges(${bookingId})"]`).style.display = 'none';
            document.querySelector(`button[onclick="cancelChanges(${bookingId})"]`).style.display = 'none';

        }
    </script>

{% endblock %}
